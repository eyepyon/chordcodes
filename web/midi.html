<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web MIDI Controller</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        input[type="url"] {
            min-width: 300px;
        }
        
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        input, select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        label {
            font-weight: bold;
            margin-right: 8px;
        }
        
        .midi-log {
            background: #1a1a1a;
            color: #00ff00;
            font-family: monospace;
            padding: 10px;
            border-radius: 5px;
            height: 150px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¹ Web MIDI Controller</h1>
        
        <div id="status" class="status">Web MIDI APIã‚’ãƒã‚§ãƒƒã‚¯ä¸­...</div>
        
        <div class="controls">
            <button id="connectBtn">MIDIæ©Ÿå™¨ã«æ¥ç¶š</button>
            <button id="testBtn" disabled>ãƒ†ã‚¹ãƒˆéŸ³ (C4)</button>
            <button id="playRevolutionaryBtn" disabled>ğŸ¹ é©å‘½ã®ã‚¨ãƒãƒ¥ãƒ¼ãƒ‰ (1åˆ†ç‰ˆ)</button>
            <button id="stopBtn" disabled>â¹ åœæ­¢</button>
        </div>
        
        <div class="controls">
            <label for="midiFileInput">ğŸ“ MIDIãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿:</label>
            <input type="file" id="midiFileInput" accept=".mid,.midi" disabled>
            <button id="playMidiFileBtn" disabled>ğŸµ MIDIãƒ•ã‚¡ã‚¤ãƒ«æ¼”å¥</button>
        </div>
        
        <div class="controls">
            <label for="presetMidiSelect">ğŸ¼ ãƒ—ãƒªã‚»ãƒƒãƒˆæ¥½æ›²:</label>
            <select id="presetMidiSelect" disabled>
                <option value="">æ¥½æ›²ã‚’é¸æŠ...</option>
                <option value="bach_invention1">ãƒãƒƒãƒ ã‚¤ãƒ³ãƒ™ãƒ³ã‚·ãƒ§ãƒ³ç¬¬1ç•ª</option>
                <option value="mozart_sonata">ãƒ¢ãƒ¼ãƒ„ã‚¡ãƒ«ãƒˆ ã‚½ãƒŠã‚¿ K.331 ç¬¬1æ¥½ç« </option>
                <option value="beethoven_moonlight">ãƒ™ãƒ¼ãƒˆãƒ¼ãƒ´ã‚§ãƒ³ æœˆå…‰ã‚½ãƒŠã‚¿ ç¬¬1æ¥½ç« </option>
                <option value="chopin_waltz">ã‚·ãƒ§ãƒ‘ãƒ³ ãƒ¯ãƒ«ãƒ„ç¬¬1ç•ª</option>
                <option value="debussy_clair">ãƒ‰ãƒ“ãƒ¥ãƒƒã‚·ãƒ¼ æœˆã®å…‰</option>
            </select>
            <button id="playPresetBtn" disabled>ğŸµ ãƒ—ãƒªã‚»ãƒƒãƒˆæ¼”å¥</button>
            <button id="loadUrlBtn" disabled>ğŸŒ URLèª­ã¿è¾¼ã¿</button>
        </div>
        
        <div class="controls">
            <label for="midiUrlInput">ğŸŒ MIDI URL:</label>
            <input type="url" id="midiUrlInput" placeholder="https://example.com/music.mid" disabled>
            <button id="loadFromUrlBtn" disabled>ğŸ“¥ URLèª­ã¿è¾¼ã¿</button>
        </div>
        
        <div class="controls">
            <label for="instrumentSelect">ğŸ¼ éŸ³è‰²é¸æŠ:</label>
            <select id="instrumentSelect" disabled>
                <option value="0">1. ã‚¢ã‚³ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ”ã‚¢ãƒ</option>
                <option value="1">2. ãƒ–ãƒ©ã‚¤ãƒˆãƒ»ã‚¢ã‚³ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ”ã‚¢ãƒ</option>
                <option value="2">3. ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ”ã‚¢ãƒ</option>
                <option value="3">4. ãƒ›ãƒ³ã‚­ãƒ¼ãƒˆãƒ³ã‚¯ãƒ»ãƒ”ã‚¢ãƒ</option>
                <option value="4">5. ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ”ã‚¢ãƒ1 (ãƒ­ãƒ¼ã‚º)</option>
                <option value="5">6. ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ”ã‚¢ãƒ2 (ã‚³ãƒ¼ãƒ©ã‚¹)</option>
                <option value="6">7. ãƒãƒ¼ãƒ—ã‚·ã‚³ãƒ¼ãƒ‰</option>
                <option value="7">8. ã‚¯ãƒ©ãƒ“</option>
                <option value="8">9. ãƒã‚§ãƒ¬ã‚¹ã‚¿</option>
                <option value="9">10. ã‚°ãƒ­ãƒƒã‚±ãƒ³ã‚·ãƒ¥ãƒ”ãƒ¼ãƒ«</option>
                <option value="10">11. ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹</option>
                <option value="11">12. ãƒ´ã‚£ãƒ–ãƒ©ãƒ•ã‚©ãƒ³</option>
                <option value="12">13. ãƒãƒªãƒ³ãƒ</option>
                <option value="13">14. ã‚·ãƒ­ãƒ•ã‚©ãƒ³</option>
                <option value="14">15. ãƒãƒ¥ãƒ¼ãƒ–ãƒ©ãƒ¼ãƒ™ãƒ«</option>
                <option value="15">16. ãƒ€ãƒ«ã‚·ãƒãƒ¼</option>
            </select>
            <button id="applyToneBtn" disabled>ğŸ¹ éŸ³è‰²é©ç”¨</button>
        </div>
        
        <div id="midiLog" class="midi-log">MIDI ãƒ­ã‚°...\n</div>
    </div>

    <script>
        class SimpleMIDIController {
            constructor() {
                this.midiAccess = null;
                this.outputDevice = null;
                this.isPlaying = false;
                this.activeNotes = new Set();
                this.loadedMidiData = null;
                
                this.init();
                this.initSong();
                this.initPresetMidi();
            }
            
            init() {
                this.statusEl = document.getElementById('status');
                this.connectBtn = document.getElementById('connectBtn');
                this.testBtn = document.getElementById('testBtn');
                this.playRevolutionaryBtn = document.getElementById('playRevolutionaryBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.midiFileInput = document.getElementById('midiFileInput');
                this.playMidiFileBtn = document.getElementById('playMidiFileBtn');
                this.presetMidiSelect = document.getElementById('presetMidiSelect');
                this.playPresetBtn = document.getElementById('playPresetBtn');
                this.midiUrlInput = document.getElementById('midiUrlInput');
                this.loadFromUrlBtn = document.getElementById('loadFromUrlBtn');
                this.instrumentSelect = document.getElementById('instrumentSelect');
                this.applyToneBtn = document.getElementById('applyToneBtn');
                this.midiLogEl = document.getElementById('midiLog');
                
                this.connectBtn.addEventListener('click', () => this.requestMIDIAccess());
                this.testBtn.addEventListener('click', () => this.playTestNote());
                this.playRevolutionaryBtn.addEventListener('click', () => this.playRevolutionary());
                this.stopBtn.addEventListener('click', () => this.stopPlayback());
                this.midiFileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.playMidiFileBtn.addEventListener('click', () => this.playMidiFile());
                this.presetMidiSelect.addEventListener('change', () => this.handlePresetSelect());
                this.playPresetBtn.addEventListener('click', () => this.playMidiFile());
                this.loadFromUrlBtn.addEventListener('click', () => this.loadFromUrl());
                this.instrumentSelect.addEventListener('change', () => this.changeInstrument());
                this.applyToneBtn.addEventListener('click', () => this.changeInstrument());
                
                this.checkMIDISupport();
            }
            
            checkMIDISupport() {
                if (navigator.requestMIDIAccess) {
                    this.showStatus('Web MIDI APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™', 'success');
                } else {
                    this.showStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web MIDI APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã¾ãŸã¯Edgeã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            }
            
            async requestMIDIAccess() {
                try {
                    this.showStatus('MIDIæ©Ÿå™¨ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...', 'info');
                    this.midiAccess = await navigator.requestMIDIAccess();
                    this.setupMIDI();
                    this.showStatus('MIDIæ©Ÿå™¨ã«æ¥ç¶šã—ã¾ã—ãŸï¼', 'success');
                } catch (error) {
                    this.showStatus(`MIDIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    this.log(`Error: ${error.message}`);
                }
            }
            
            setupMIDI() {
                this.testBtn.disabled = false;
                this.playRevolutionaryBtn.disabled = false;
                this.midiFileInput.disabled = false;
                this.presetMidiSelect.disabled = false;
                this.midiUrlInput.disabled = false;
                this.loadFromUrlBtn.disabled = false;
                this.instrumentSelect.disabled = false;
                this.applyToneBtn.disabled = false;
                
                // æœ€åˆã®å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ã‚’è‡ªå‹•é¸æŠ
                for (const output of this.midiAccess.outputs.values()) {
                    this.outputDevice = output;
                    this.log(`å‡ºåŠ›æ©Ÿå™¨é¸æŠ: ${output.name}`);
                    break;
                }
                
                if (!this.outputDevice) {
                    this.log('å‡ºåŠ›å¯èƒ½ãªMIDIæ©Ÿå™¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¢ã‚³ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ”ã‚¢ãƒã«è¨­å®š
                    this.changeInstrument();
                }
            }
            
            playTestNote() {
                if (!this.outputDevice) {
                    this.log('å‡ºåŠ›æ©Ÿå™¨ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                const noteNumber = 60; // C4
                const velocity = 100;
                
                // Note On
                const noteOnMessage = [0x90, noteNumber, velocity];
                this.outputDevice.send(noteOnMessage);
                this.log(`Note On: ${noteNumber} velocity: ${velocity}`);
                
                // 500mså¾Œã«Note Off
                setTimeout(() => {
                    const noteOffMessage = [0x80, noteNumber, 0];
                    this.outputDevice.send(noteOffMessage);
                    this.log(`Note Off: ${noteNumber}`);
                }, 500);
            }
            
            initSong() {
                // ã‚·ãƒ§ãƒ‘ãƒ³ é©å‘½ã®ã‚¨ãƒãƒ¥ãƒ¼ãƒ‰ Op.10-12 - å®Œå…¨ç‰ˆ (ç´„60ç§’)
                this.revolutionary = [
                    // ç¬¬1æ¥½ç« ï¼šåŠ‡çš„ãªé–‹å§‹
                    { notes: [72, 36, 48], duration: 800 },
                    { notes: [71, 35], duration: 400 },
                    { notes: [69, 33], duration: 400 },
                    { notes: [67, 31], duration: 600 },
                    
                    // ç¬¬2æ¥½ç« ï¼šå·¦æ‰‹ã®åµ
                    { notes: [65, 48, 60, 65], duration: 150 },
                    { notes: [64], duration: 120 },
                    { notes: [62], duration: 120 },
                    { notes: [60], duration: 120 },
                    { notes: [59], duration: 120 },
                    { notes: [57], duration: 120 },
                    { notes: [55], duration: 120 },
                    { notes: [53], duration: 120 },
                    { notes: [52], duration: 120 },
                    { notes: [50], duration: 120 },
                    { notes: [48], duration: 200 },
                    
                    // ç¬¬3æ¥½ç« ï¼šå³æ‰‹ã®è‹±é›„çš„ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼
                    { notes: [77, 41, 53, 57], duration: 500 },
                    { notes: [75], duration: 250 },
                    { notes: [74], duration: 250 },
                    { notes: [72, 43, 55, 60], duration: 500 },
                    { notes: [70], duration: 250 },
                    { notes: [69], duration: 250 },
                    
                    { notes: [67, 48, 60, 64], duration: 300 },
                    { notes: [65, 53], duration: 150 },
                    { notes: [64, 52], duration: 150 },
                    { notes: [62, 50], duration: 150 },
                    { notes: [60, 48], duration: 150 },
                    { notes: [59, 47], duration: 150 },
                    { notes: [57, 45], duration: 150 },
                    { notes: [55, 43], duration: 150 },
                    { notes: [53, 41], duration: 150 },
                    
                    // ç¬¬4æ¥½ç« ï¼šæŠ€å·§çš„å±•é–‹éƒ¨
                    { notes: [84, 48, 60, 72], duration: 600 },
                    { notes: [82, 58, 70], duration: 300 },
                    { notes: [80, 56, 68], duration: 300 },
                    { notes: [79, 55, 67], duration: 400 },
                    { notes: [77, 53, 65], duration: 400 },
                    { notes: [75, 51, 63], duration: 400 },
                    
                    // ç¬¬5æ¥½ç« ï¼šé«˜é€Ÿãƒ‘ãƒƒã‚»ãƒ¼ã‚¸
                    { notes: [72], duration: 100 },
                    { notes: [74], duration: 100 },
                    { notes: [75], duration: 100 },
                    { notes: [77], duration: 100 },
                    { notes: [79], duration: 100 },
                    { notes: [80], duration: 100 },
                    { notes: [82], duration: 100 },
                    { notes: [84], duration: 100 },
                    { notes: [85], duration: 100 },
                    { notes: [87], duration: 100 },
                    { notes: [89], duration: 200 },
                    
                    // ç¬¬6æ¥½ç« ï¼šæ„Ÿæƒ…çš„ãªä¸­é–“éƒ¨
                    { notes: [67, 43, 55, 67], duration: 800 },
                    { notes: [65, 41, 53, 65], duration: 400 },
                    { notes: [64, 40, 52, 64], duration: 400 },
                    { notes: [62, 38, 50, 62], duration: 600 },
                    { notes: [60, 36, 48, 60], duration: 600 },
                    
                    // ç¬¬7æ¥½ç« ï¼šå†ç¾éƒ¨
                    { notes: [72, 36, 48], duration: 600 },
                    { notes: [74, 38, 50], duration: 300 },
                    { notes: [75, 39, 51], duration: 300 },
                    { notes: [77, 41, 53], duration: 400 },
                    { notes: [79, 43, 55], duration: 400 },
                    
                    // ç¬¬8æ¥½ç« ï¼šåµã®ã‚ˆã†ãªä¸‹é™
                    { notes: [89, 65], duration: 150 },
                    { notes: [87, 63], duration: 120 },
                    { notes: [85, 61], duration: 120 },
                    { notes: [84, 60], duration: 120 },
                    { notes: [82, 58], duration: 120 },
                    { notes: [80, 56], duration: 120 },
                    { notes: [79, 55], duration: 120 },
                    { notes: [77, 53], duration: 120 },
                    { notes: [75, 51], duration: 120 },
                    { notes: [74, 50], duration: 120 },
                    { notes: [72, 48], duration: 120 },
                    { notes: [70, 46], duration: 120 },
                    { notes: [69, 45], duration: 120 },
                    { notes: [67, 43], duration: 120 },
                    { notes: [65, 41], duration: 150 },
                    
                    // ç¬¬9æ¥½ç« ï¼šåŠ›å¼·ã„ä¸Šæ˜‡
                    { notes: [48], duration: 150 },
                    { notes: [50], duration: 120 },
                    { notes: [52], duration: 120 },
                    { notes: [53], duration: 120 },
                    { notes: [55], duration: 120 },
                    { notes: [57], duration: 120 },
                    { notes: [59], duration: 120 },
                    { notes: [60], duration: 120 },
                    { notes: [62], duration: 120 },
                    { notes: [64], duration: 120 },
                    { notes: [65], duration: 120 },
                    { notes: [67], duration: 120 },
                    { notes: [69], duration: 120 },
                    { notes: [70], duration: 120 },
                    { notes: [72], duration: 200 },
                    
                    // ç¬¬10æ¥½ç« ï¼šå£®å¤§ãªã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹
                    { notes: [84, 36, 48, 60, 72], duration: 500 },
                    { notes: [87, 39, 51, 63, 75], duration: 400 },
                    { notes: [89, 41, 53, 65, 77], duration: 400 },
                    { notes: [91, 43, 55, 67, 79], duration: 600 },
                    
                    // ç¬¬11æ¥½ç« ï¼šæ„Ÿå‹•çš„ãªçµ‚çµ
                    { notes: [84, 48, 60, 72], duration: 400 },
                    { notes: [79, 43, 55, 67], duration: 300 },
                    { notes: [84, 48, 60, 72], duration: 300 },
                    { notes: [89, 53, 65, 77], duration: 400 },
                    { notes: [84, 36, 48, 60, 72], duration: 1200 },
                ];
            }
            
            async playRevolutionary() {
                if (this.isPlaying || !this.outputDevice) return;
                
                this.isPlaying = true;
                this.playRevolutionaryBtn.disabled = true;
                this.stopBtn.disabled = false;
                this.log('ğŸ¹ é©å‘½ã®ã‚¨ãƒãƒ¥ãƒ¼ãƒ‰æ¼”å¥é–‹å§‹');
                
                try {
                    for (let i = 0; i < this.revolutionary.length && this.isPlaying; i++) {
                        const { notes, duration } = this.revolutionary[i];
                        
                        if (Array.isArray(notes)) {
                            // å’ŒéŸ³æ¼”å¥
                            for (const note of notes) {
                                this.playNote(note, 100);
                            }
                            await this.sleep(duration * 0.9);
                            for (const note of notes) {
                                this.stopNote(note);
                            }
                        } else {
                            // å˜éŸ³æ¼”å¥
                            this.playNote(notes, 100);
                            await this.sleep(duration * 0.9);
                            this.stopNote(notes);
                        }
                        
                        if (this.isPlaying) {
                            await this.sleep(duration * 0.1);
                        }
                    }
                } catch (error) {
                    this.log(`æ¼”å¥ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                this.stopPlayback();
            }
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆMIDIãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            initPresetMidi() {
                // å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ç’°å¢ƒã§ã¯ã€ã“ã‚Œã‚‰ã®URLã‚’é©åˆ‡ãªãƒ‘ã‚¹ã«å¤‰æ›´ã—ã¦ãã ã•ã„
                this.presetMidiUrls = {
                    'bach_invention1': './midi/bach_invention1.mid',
                    'mozart_sonata': './midi/mozart_sonata.mid', 
                    'beethoven_moonlight': './midi/beethoven_moonlight.mid',
                    'chopin_waltz': './midi/chopin_waltz.mid',
                    'debussy_clair': './midi/debussy_clair.mid'
                };
            }
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆæ¥½æ›²é¸æŠ
            async handlePresetSelect() {
                const selectedValue = this.presetMidiSelect.value;
                if (selectedValue) {
                    this.log(`ğŸ¼ ãƒ—ãƒªã‚»ãƒƒãƒˆæ¥½æ›²é¸æŠ: ${this.presetMidiSelect.options[this.presetMidiSelect.selectedIndex].text}`);
                    
                    // ãƒ—ãƒªã‚»ãƒƒãƒˆæ¥½æ›²ã‚’ç›´æ¥èª­ã¿è¾¼ã¿
                    const url = this.presetMidiUrls[selectedValue];
                    await this.loadMidiFromUrl(url);
                    
                    if (this.loadedMidiData) {
                        this.playPresetBtn.disabled = false;
                    }
                } else {
                    this.playPresetBtn.disabled = true;
                }
            }
            
            // URL ã‹ã‚‰MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            async loadFromUrl() {
                const url = this.midiUrlInput.value.trim();
                if (!url) {
                    this.log('âŒ URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                await this.loadMidiFromUrl(url);
            }
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆã¾ãŸã¯URLã‹ã‚‰MIDIèª­ã¿è¾¼ã¿
            async loadMidiFromUrl(url) {
                this.log(`ğŸŒ MIDIèª­ã¿è¾¼ã¿ä¸­: ${url}`);
                
                try {
                    // ã¾ãšåŸºæœ¬çš„ãªfetchã‚’è©¦è¡Œ
                    let response;
                    
                    try {
                        response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'audio/midi, application/octet-stream, */*'
                            }
                        });
                    } catch (fetchError) {
                        // CORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã‚’è©¦è¡Œ
                        this.log(`âš ï¸ ç›´æ¥èª­ã¿è¾¼ã¿å¤±æ•—ã€ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã‚’è©¦è¡Œ...`);
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                        response = await fetch(proxyUrl);
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const arrayBuffer = await response.arrayBuffer();
                    
                    // ArrayBufferãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
                    if (arrayBuffer.byteLength === 0) {
                        throw new Error('ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                    }
                    
                    this.log(`ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${arrayBuffer.byteLength} bytes`);
                    
                    const midiData = this.parseMIDI(arrayBuffer);
                    
                    if (midiData && midiData.length > 0) {
                        this.loadedMidiData = midiData;
                        this.playMidiFileBtn.disabled = false;
                        this.log(`âœ… MIDIèª­ã¿è¾¼ã¿å®Œäº†: ${midiData.length}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆ`);
                    } else {
                        this.log('âŒ æœ‰åŠ¹ãªMIDIãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        this.log('ğŸ’¡ ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„MIDIå½¢å¼ã‹ç¢ºèªã—ã¦ãã ã•ã„');
                    }
                } catch (error) {
                    this.log(`âŒ MIDIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    
                    // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æä¾›
                    if (error.message.includes('CORS') || error.message.includes('fetch')) {
                        this.log('ğŸ’¡ è§£æ±ºæ–¹æ³•:');
                        this.log('  1. ã‚µãƒ¼ãƒãƒ¼ã§CORSã‚’æœ‰åŠ¹åŒ–');
                        this.log('  2. åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®');
                        this.log('  3. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚’ä½¿ç”¨');
                    } else if (error.message.includes('404')) {
                        this.log('ğŸ’¡ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    } else if (error.message.includes('500')) {
                        this.log('ğŸ’¡ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã€‚ã‚µãƒ¼ãƒãƒ¼è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    }
                }
            }
            
            playNote(note, velocity) {
                if (!this.outputDevice || this.activeNotes.has(note)) return;
                
                const noteOnMessage = [0x90, note, velocity];
                this.outputDevice.send(noteOnMessage);
                this.activeNotes.add(note);
            }
            
            stopNote(note) {
                if (!this.outputDevice || !this.activeNotes.has(note)) return;
                
                const noteOffMessage = [0x80, note, 0];
                this.outputDevice.send(noteOffMessage);
                this.activeNotes.delete(note);
            }
            
            stopPlayback() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                
                // å…¨ã¦ã®éŸ³ã‚’åœæ­¢
                for (const note of this.activeNotes) {
                    this.stopNote(note);
                }
                
                this.playRevolutionaryBtn.disabled = false;
                this.playMidiFileBtn.disabled = this.loadedMidiData ? false : true;
                this.playPresetBtn.disabled = this.presetMidiSelect.value ? false : true;
                this.stopBtn.disabled = true;
                this.log('ğŸ›‘ æ¼”å¥åœæ­¢');
            }
            
            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            changeInstrument() {
                if (!this.outputDevice) return;
                
                const programNumber = parseInt(this.instrumentSelect.value);
                const instrumentNames = [
                    'ã‚¢ã‚³ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ”ã‚¢ãƒ',
                    'ãƒ–ãƒ©ã‚¤ãƒˆãƒ»ã‚¢ã‚³ãƒ¼ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ”ã‚¢ãƒ',
                    'ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ”ã‚¢ãƒ',
                    'ãƒ›ãƒ³ã‚­ãƒ¼ãƒˆãƒ³ã‚¯ãƒ»ãƒ”ã‚¢ãƒ',
                    'ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ”ã‚¢ãƒ1 (ãƒ­ãƒ¼ã‚º)',
                    'ã‚¨ãƒ¬ã‚¯ãƒˆãƒªãƒƒã‚¯ãƒ”ã‚¢ãƒ2 (ã‚³ãƒ¼ãƒ©ã‚¹)',
                    'ãƒãƒ¼ãƒ—ã‚·ã‚³ãƒ¼ãƒ‰',
                    'ã‚¯ãƒ©ãƒ“',
                    'ãƒã‚§ãƒ¬ã‚¹ã‚¿',
                    'ã‚°ãƒ­ãƒƒã‚±ãƒ³ã‚·ãƒ¥ãƒ”ãƒ¼ãƒ«',
                    'ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹',
                    'ãƒ´ã‚£ãƒ–ãƒ©ãƒ•ã‚©ãƒ³',
                    'ãƒãƒªãƒ³ãƒ',
                    'ã‚·ãƒ­ãƒ•ã‚©ãƒ³',
                    'ãƒãƒ¥ãƒ¼ãƒ–ãƒ©ãƒ¼ãƒ™ãƒ«',
                    'ãƒ€ãƒ«ã‚·ãƒãƒ¼'
                ];
                
                // Program Change ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
                this.outputDevice.send([0xC0, programNumber]);
                
                const instrumentName = instrumentNames[programNumber] || `æ¥½å™¨ ${programNumber + 1}`;
                this.log(`ğŸ¼ éŸ³è‰²å¤‰æ›´: ${instrumentName}`);
            }
            
            showStatus(message, type = 'info') {
                this.statusEl.textContent = message;
                this.statusEl.className = `status ${type}`;
            }
            
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.midiLogEl.textContent += `[${timestamp}] ${message}\n`;
                this.midiLogEl.scrollTop = this.midiLogEl.scrollHeight;
            }
            
            // MIDIãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†
            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                this.log(`ğŸ“ MIDIãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­: ${file.name}`);
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const midiData = this.parseMIDI(arrayBuffer);
                    
                    if (midiData && midiData.length > 0) {
                        this.loadedMidiData = midiData;
                        this.playMidiFileBtn.disabled = false;
                        this.log(`âœ… MIDIãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${midiData.length}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆ`);
                    } else {
                        this.log('âŒ æœ‰åŠ¹ãªMIDIãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                } catch (error) {
                    this.log(`âŒ MIDIãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
            
            // ç°¡æ˜“MIDIãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆåŸºæœ¬çš„ãªNote Onã¨Note Offã®ã¿ï¼‰
            parseMIDI(arrayBuffer) {
                try {
                    const view = new DataView(arrayBuffer);
                    const events = [];
                    let position = 0;
                    let currentTime = 0;
                    
                    this.log(`ğŸ“‹ MIDIãƒ•ã‚¡ã‚¤ãƒ«è§£æé–‹å§‹: ${arrayBuffer.byteLength} bytes`);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€åˆã®16ãƒã‚¤ãƒˆã‚’16é€²æ•°ã§è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    let hexDump = '';
                    for (let i = 0; i < Math.min(16, arrayBuffer.byteLength); i++) {
                        hexDump += view.getUint8(i).toString(16).padStart(2, '0').toUpperCase() + ' ';
                    }
                    this.log(`ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­16bytes: ${hexDump}`);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€åˆã®4æ–‡å­—ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤º
                    let textHeader = '';
                    for (let i = 0; i < Math.min(4, arrayBuffer.byteLength); i++) {
                        const char = String.fromCharCode(view.getUint8(i));
                        textHeader += char;
                    }
                    this.log(`ğŸ“ ãƒ˜ãƒƒãƒ€ãƒ¼æ–‡å­—: "${textHeader}"`);
                    
                    if (arrayBuffer.byteLength < 14) {
                        throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã™ãã¾ã™ (${arrayBuffer.byteLength} bytes, æœ€ä½14byteså¿…è¦)`);
                    }
                    
                    const headerSignature = view.getUint32(0);
                    this.log(`ğŸ·ï¸ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚·ã‚°ãƒãƒãƒ£: 0x${headerSignature.toString(16).toUpperCase()}`);
                    
                    if (headerSignature !== 0x4D546864) { // "MThd"
                        // ã‚ˆãã‚ã‚‹é–“é•ã„ã‚’ãƒã‚§ãƒƒã‚¯
                        if (textHeader === 'RIFF') {
                            throw new Error('ã“ã‚Œã¯RIFFãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆWAVãªã©ï¼‰ã§ã™ã€‚MIDIãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                        } else if (textHeader.includes('HTML') || textHeader.includes('<')) {
                            throw new Error('ã“ã‚Œã¯HTMLãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚404ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                        } else if (arrayBuffer.byteLength < 100) {
                            throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã™ãã¾ã™ã€‚ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                        } else {
                            throw new Error(`ç„¡åŠ¹ãªMIDIãƒ˜ãƒƒãƒ€ãƒ¼: "${textHeader}" (æœŸå¾…å€¤: "MThd")`);
                        }
                    }
                    
                    const headerLength = view.getUint32(4);
                    const format = view.getUint16(8);
                    const trackCount = view.getUint16(10);
                    const division = view.getUint16(12);
                    
                    this.log(`ğŸ“Š MIDIæƒ…å ±:`);
                    this.log(`  - ãƒ˜ãƒƒãƒ€ãƒ¼é•·: ${headerLength}`);
                    this.log(`  - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ${format}`);
                    this.log(`  - ãƒˆãƒ©ãƒƒã‚¯æ•°: ${trackCount}`);
                    this.log(`  - åˆ†è§£èƒ½: ${division}`);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
                    if (format > 2) {
                        throw new Error(`æœªå¯¾å¿œã®MIDIãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ${format} (0-2ã®ã¿å¯¾å¿œ)`);
                    }
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’èª­ã¿é£›ã°ã™
                    position = 8 + headerLength;
                    this.log(`ğŸ“ ãƒˆãƒ©ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿é–‹å§‹ä½ç½®: ${position}`);
                    
                    // ãƒˆãƒ©ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã™
                    let tracksProcessed = 0;
                    while (position < arrayBuffer.byteLength - 8 && tracksProcessed < 1) { // æœ€åˆã®ãƒˆãƒ©ãƒƒã‚¯ã®ã¿
                        if (position + 8 > arrayBuffer.byteLength) {
                            this.log(`âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾ã«åˆ°é” (ä½ç½®: ${position})`);
                            break;
                        }
                        
                        const chunkType = view.getUint32(position);
                        const chunkLength = view.getUint32(position + 4);
                        
                        // ãƒãƒ£ãƒ³ã‚¯ã‚¿ã‚¤ãƒ—ã‚’æ–‡å­—åˆ—ã¨ã—ã¦è¡¨ç¤º
                        let chunkTypeStr = '';
                        for (let i = 0; i < 4; i++) {
                            chunkTypeStr += String.fromCharCode((chunkType >> (24 - i * 8)) & 0xFF);
                        }
                        this.log(`ğŸµ ãƒãƒ£ãƒ³ã‚¯ç™ºè¦‹: "${chunkTypeStr}" (é•·ã•: ${chunkLength})`);
                        
                        if (chunkType === 0x4D54726B) { // "MTrk"
                            this.log(`âœ… ãƒˆãƒ©ãƒƒã‚¯${tracksProcessed + 1}ã‚’å‡¦ç†ä¸­...`);
                            position += 8; // ãƒãƒ£ãƒ³ã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                            const trackEnd = Math.min(position + chunkLength, arrayBuffer.byteLength);
                            
                            let eventCount = 0;
                            while (position < trackEnd - 2 && eventCount < 1000) { // å®‰å…¨ã®ãŸã‚æœ€å¤§1000ã‚¤ãƒ™ãƒ³ãƒˆ
                                try {
                                    // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ èª­ã¿å–ã‚Šï¼ˆæ”¹è‰¯ç‰ˆï¼‰
                                    let deltaTime = 0;
                                    let byte;
                                    let bytesRead = 0;
                                    do {
                                        if (position >= trackEnd) break;
                                        byte = view.getUint8(position++);
                                        deltaTime = (deltaTime << 7) | (byte & 0x7F);
                                        bytesRead++;
                                        if (bytesRead > 4) break; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
                                    } while (byte & 0x80);
                                    
                                    currentTime += deltaTime;
                                    
                                    if (position >= trackEnd) break;
                                    
                                    const status = view.getUint8(position++);
                                    eventCount++;
                                    
                                    // Note On (0x90-0x9F)
                                    if ((status & 0xF0) === 0x90) {
                                        if (position + 1 < trackEnd) {
                                            const note = view.getUint8(position++);
                                            const velocity = view.getUint8(position++);
                                            
                                            if (velocity > 0) {
                                                events.push({
                                                    time: Math.max(0, currentTime * 3), // ã‚¿ã‚¤ãƒŸãƒ³ã‚°èª¿æ•´
                                                    type: 'noteOn',
                                                    note: note,
                                                    velocity: Math.min(127, velocity)
                                                });
                                            } else {
                                                events.push({
                                                    time: Math.max(0, currentTime * 3),
                                                    type: 'noteOff',
                                                    note: note
                                                });
                                            }
                                        }
                                    }
                                    // Note Off (0x80-0x8F)
                                    else if ((status & 0xF0) === 0x80) {
                                        if (position + 1 < trackEnd) {
                                            const note = view.getUint8(position++);
                                            const velocity = view.getUint8(position++);
                                            
                                            events.push({
                                                time: Math.max(0, currentTime * 3),
                                                type: 'noteOff',
                                                note: note
                                            });
                                        }
                                    }
                                    // ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—
                                    else if (status >= 0x80) {
                                        if (status === 0xFF) { // ãƒ¡ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆ
                                            if (position < trackEnd) {
                                                const metaType = view.getUint8(position++);
                                                let length = 0;
                                                let byte;
                                                let bytesRead = 0;
                                                do {
                                                    if (position >= trackEnd) break;
                                                    byte = view.getUint8(position++);
                                                    length = (length << 7) | (byte & 0x7F);
                                                    bytesRead++;
                                                    if (bytesRead > 4) break;
                                                } while (byte & 0x80);
                                                position = Math.min(position + length, trackEnd);
                                            }
                                        } else if ((status & 0xF0) === 0xC0 || (status & 0xF0) === 0xD0) {
                                            // ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒã‚§ãƒ³ã‚¸ã€ãƒãƒ£ãƒ³ãƒãƒ«ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ï¼ˆ1ãƒã‚¤ãƒˆï¼‰
                                            if (position < trackEnd) position++;
                                        } else {
                                            // ãã®ä»–ã®ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ2ãƒã‚¤ãƒˆï¼‰
                                            position = Math.min(position + 2, trackEnd);
                                        }
                                    }
                                } catch (e) {
                                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯æ¬¡ã®ãƒã‚¤ãƒˆã¸
                                    this.log(`âš ï¸ è§£æã‚¨ãƒ©ãƒ¼ (ä½ç½®${position}): ${e.message}`);
                                    position++;
                                    continue;
                                }
                            }
                            this.log(`ğŸ“Š ãƒˆãƒ©ãƒƒã‚¯${tracksProcessed + 1}: ${eventCount}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†`);
                            tracksProcessed++;
                        } else {
                            this.log(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: "${chunkTypeStr}"`);
                            position += 8 + chunkLength;
                        }
                    }
                    
                    const sortedEvents = events.sort((a, b) => a.time - b.time);
                    this.log(`âœ… è§£æå®Œäº†: ${sortedEvents.length}å€‹ã®éŸ³ç¬¦ã‚¤ãƒ™ãƒ³ãƒˆ`);
                    
                    if (sortedEvents.length === 0) {
                        this.log(`âš ï¸ éŸ³ç¬¦ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                        this.log(`ğŸ’¡ ã“ã®MIDIãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯æ¼”å¥å¯èƒ½ãªéŸ³ç¬¦ãŒå«ã¾ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™`);
                    }
                    
                    return sortedEvents;
                } catch (error) {
                    this.log(`âŒ MIDIãƒ‘ãƒ¼ã‚¹ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    return [];
                }
            }
            
            // MIDIãƒ•ã‚¡ã‚¤ãƒ«æ¼”å¥
            async playMidiFile() {
                if (this.isPlaying || !this.outputDevice || !this.loadedMidiData) return;
                
                this.isPlaying = true;
                this.playMidiFileBtn.disabled = true;
                this.playRevolutionaryBtn.disabled = true;
                this.stopBtn.disabled = false;
                this.log('ğŸµ MIDIãƒ•ã‚¡ã‚¤ãƒ«æ¼”å¥é–‹å§‹');
                
                try {
                    let lastTime = 0;
                    
                    for (const event of this.loadedMidiData) {
                        if (!this.isPlaying) break;
                        
                        // å¾…æ©Ÿæ™‚é–“
                        const waitTime = event.time - lastTime;
                        if (waitTime > 0) {
                            await this.sleep(waitTime);
                        }
                        
                        if (!this.isPlaying) break;
                        
                        // MIDIã‚¤ãƒ™ãƒ³ãƒˆå®Ÿè¡Œ
                        if (event.type === 'noteOn') {
                            this.playNote(event.note, event.velocity || 100);
                        } else if (event.type === 'noteOff') {
                            this.stopNote(event.note);
                        }
                        
                        lastTime = event.time;
                    }
                } catch (error) {
                    this.log(`MIDIãƒ•ã‚¡ã‚¤ãƒ«æ¼”å¥ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                this.stopPlayback();
            }
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            new SimpleMIDIController();
        });
    </script>
</body>
</html>